<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë‚˜ë§Œì˜ í’ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ê¾¸ë¯¸ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&family=Jua&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            font-weight: 700;
            overflow: hidden;
            touch-action: none;
            /* ë°°ê²½ìƒ‰: í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë ˆë“œ */
            background-color: #bf2e3d;
            height: 100vh;
            height: 100dvh;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: none; 
            user-select: none;
        }

        .scene-bg {
            position: absolute;
            inset: 0;
            /* ë°°ê²½ ê·¸ë¼ë°ì´ì…˜ */
            background: radial-gradient(circle at 50% 30%, #d64552 0%, #bf2e3d 60%, #751a23 100%);
            z-index: 0;
            overflow: hidden;
        }

        #foreground-layer {
            position: absolute;
            inset: 0;
            z-index: 100;
            pointer-events: none;
            background-image: url('game/Untitled-1.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* ëˆˆ ë‚´ë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        .snowflake {
            position: absolute;
            top: -20px;
            color: white;
            opacity: 0.9;
            animation: fall linear forwards;
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 5px white;
            will-change: transform;
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(360deg); }
        }

        /* LED ì „êµ¬ & ë³„ ë°˜ì§ì„ íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes led-blink {
            0% { filter: drop-shadow(0 0 2px currentColor) brightness(1); }
            50% { filter: drop-shadow(0 0 15px currentColor) brightness(1.4); }
            100% { filter: drop-shadow(0 0 2px currentColor) brightness(1); }
        }
        
        .placed-item.led-anim {
            animation: led-blink 1.5s infinite alternate ease-in-out;
        }

        /* ê¸°ë³¸(ëª¨ë°”ì¼) íŠ¸ë¦¬ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .tree-container {
            position: relative;
            width: 80vw; 
            max-width: 450px; 
            height: auto;
            max-height: 55vh; 
            aspect-ratio: 340/480;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
            z-index: 20;
            transition: transform 0.3s;
        }

        /* PC/íƒœë¸”ë¦¿ (ê°€ë¡œê°€ ë„“ì€ í™”ë©´) ëŒ€ì‘ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (min-width: 1024px) {
            /* UI íŒ¨ë„ì„ ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”ë¡œ ë³€ê²½ */
            #ui-panel {
                width: 400px !important;
                height: 100vh !important;
                top: 0;
                right: 0;
                bottom: auto !important;
                left: auto !important;
                border-radius: 24px 0 0 24px !important;
                box-shadow: -10px 0 30px rgba(0,0,0,0.3) !important;
            }

            /* ë©”ì¸ ì˜ì—­ì´ ì‚¬ì´ë“œë°”ë¥¼ ì¹¨ë²”í•˜ì§€ ì•Šë„ë¡ ì¡°ì • */
            main {
                width: calc(100vw - 400px) !important;
                margin-right: 400px;
                padding-bottom: 0 !important; 
            }

            /* ìƒë‹¨ íˆ´ë°” ë° í”„ë¦¬ë·° ì»¨íŠ¸ë¡¤ ìœ„ì¹˜ ì¡°ì • */
            #top-toolbar, #preview-controls {
                width: calc(100% - 400px) !important;
                left: 0 !important;
            }

            /* PCì—ì„œëŠ” íŠ¸ë¦¬ í¬ê²Œ */
            .tree-container {
                width: auto !important;
                height: 85vh !important; 
                max-width: none !important;
                max-height: none !important;
            }
        }

        /* [ì¤‘ìš”] ìº¡ì²˜(ì €ì¥) ëª¨ë“œì¼ ë•Œ ì ìš©ë˜ëŠ” ê°•ì œ ìŠ¤íƒ€ì¼ */
        body.capture-mode #ui-panel,
        body.capture-mode #top-toolbar,
        body.capture-mode #preview-controls,
        body.capture-mode #reset-modal {
            display: none !important; /* UI ìˆ¨ê¹€ */
        }
        
        body.capture-mode main {
            width: 100vw !important;
            margin-right: 0 !important;
            padding-bottom: 0 !important;
            background: transparent !important;
        }
        
        body.capture-mode .tree-container {
            /* ìº¡ì²˜ ì‹œ íŠ¸ë¦¬ë¥¼ í™”ë©´ ì¤‘ì•™ì— ê½‰ ì°¨ê²Œ ë°°ì¹˜ */
            width: auto !important;
            height: 85vh !important;
            max-width: none !important;
            max-height: none !important;
            margin: 0 auto !important;
            left: auto !important;
            top: auto !important;
            transform: none !important;
        }

        .placed-item {
            position: absolute;
            cursor: grab; 
            filter: drop-shadow(2px 3px 0px rgba(0,0,0,0.2));
            touch-action: none;
            z-index: 50;
            box-sizing: border-box;
            transform-origin: center center;
        }
        .placed-item.is-dragging {
            cursor: grabbing;
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.4));
            z-index: 100; 
        }

        .placed-item.selected {
            border: 2px dashed #3b82f6;
            z-index: 90;
        }

        .resizer {
            width: 30px; 
            height: 30px;
            background: #3b82f6;
            border: 3px solid #fff;
            border-radius: 50%;
            position: absolute;
            bottom: -15px;
            right: -15px;
            cursor: se-resize;
            z-index: 101;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .rotator {
            width: 24px;
            height: 24px;
            background: #fff;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            cursor: grab;
            z-index: 101;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .rotator::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background-color: #3b82f6;
            z-index: -1;
        }
        
        .placed-item.selected .resizer,
        .placed-item.selected .rotator {
            display: block;
        }
        
        .sketch-panel {
            background: #fdfbf7;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
        }
        
        /* ì˜¤ë„ˆë¨¼íŠ¸ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
        .shelf-slot {
            background: #fff;
            border-radius: 16px;
            border: 2px dashed #cbd5e1;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; 
            padding: 6px;
            height: auto; 
            min-height: 110px;
        }
        .shelf-slot:active {
            background: #f1f5f9;
            border-color: #94a3b8;
            transform: scale(0.95);
        }
        .shelf-slot svg, .shelf-slot img {
            width: 100%;
            height: 60px;
            object-fit: contain;
            pointer-events: none;
            flex-shrink: 0;
        }
        .item-name {
            margin-top: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #475569;
            text-align: center;
            line-height: 1.2;
            word-break: keep-all;
            display: block;
            overflow: visible;
            height: auto;
        }

        .tool-btn {
            background: #fff;
            border: 2px solid #94a3b8;
            color: #475569;
            border-radius: 16px;
            padding: 10px 16px;
            transition: all 0.1s;
            box-shadow: 0 4px 0 #cbd5e1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .tool-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cbd5e1;
        }

        .page-btn {
            background: #fff;
            color: #475569;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid #cbd5e1;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .page-btn:disabled {
            opacity: 0.3;
            border-color: #e2e8f0;
        }
        .page-btn:active:not(:disabled) {
            background: #f1f5f9;
            transform: scale(0.95);
        }

        .drag-clone {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%) scale(1.2) rotate(-5deg);
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.2));
        }

        #loading-overlay, #reset-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 9999;
            font-size: 1.5rem;
            flex-direction: column;
        }
        .hidden { display: none !important; }

        .preview-mode #top-toolbar, 
        .preview-mode #ui-panel {
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        .preview-mode #top-toolbar {
            transform: translateY(-150%);
        }
        
        #preview-controls {
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .preview-mode #preview-controls {
            transform: translateY(0);
        }

        #top-toolbar, #ui-panel {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
    </style>
</head>
<body class="flex flex-col text-slate-800 select-none">

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ ì‚­ì œë¨ -->

    <!-- ì´ˆê¸°í™” í™•ì¸ ëª¨ë‹¬ -->
    <div id="reset-modal" class="hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs mx-4 animation-popup">
            <p class="text-xl font-bold text-slate-700 mb-6">ëª¨ë“  ì¥ì‹ì„ ì§€ìš°ê³ <br>ì²˜ìŒë¶€í„° ë‹¤ì‹œ í• ê¹Œìš”?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="performReset()" class="bg-red-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-red-600 transition text-lg">ë„¤</button>
                <button onclick="closeResetModal()" class="bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold hover:bg-slate-300 transition text-lg">ì•„ë‹ˆìš”</button>
            </div>
        </div>
    </div>

    <div id="foreground-layer"></div>

    <div class="scene-bg">
        <!-- ë‹¬(moon) ì‚­ì œë¨ -->
        <div id="custom-bg-layer" class="hidden"></div>
    </div>

    <div id="snow-container" class="absolute inset-0 pointer-events-none z-10"></div>

    <main class="relative flex-1 flex flex-col items-center justify-center w-full overflow-hidden z-20" id="capture-area">
        
        <div id="top-toolbar" class="absolute top-6 left-0 w-full px-5 flex justify-between items-center z-50 pointer-events-auto" data-html2canvas-ignore>
            <button onclick="openResetModal()" class="tool-btn bg-white/90 font-bold" title="ìƒˆë¡œê³ ì¹¨">
                <span class="mr-2 text-xl">ğŸ”„</span> ìƒˆë¡œê³ ì¹¨
            </button>
            
            <button onclick="togglePreviewMode(true)" class="tool-btn bg-white/90 font-bold" title="ë¯¸ë¦¬ë³´ê¸°">
                <span class="mr-2 text-xl">ğŸ‘ï¸</span> ë¯¸ë¦¬ë³´ê¸°
            </button>
        </div>

        <div class="tree-container flex items-center justify-center" id="drop-zone">
            
            <!-- ê¸°ë³¸ íŠ¸ë¦¬ SVG -->
            <svg id="default-tree-svg" viewBox="0 0 400 550" class="w-full h-full pointer-events-none hidden">
                <defs>
                    <filter id="displacementFilter">
                        <feTurbulence type="turbulence" baseFrequency="0.01" numOctaves="3" result="turbulence" />
                        <feDisplacementMap in2="turbulence" in="SourceGraphic" scale="5" xChannelSelector="R" yChannelSelector="G" />
                    </filter>
                    <linearGradient id="softGreen" x1="0" y1="0" x2="1" y2="1">
                        <stop offset="0%" stop-color="#86efac" />
                        <stop offset="100%" stop-color="#16a34a" />
                    </linearGradient>
                </defs>
                <ellipse cx="200" cy="520" rx="110" ry="15" fill="rgba(0,0,0,0.2)" filter="url(#displacementFilter)" />
                <path d="M180,480 L185,520 L215,520 L220,480 Z" fill="#78350f" filter="url(#displacementFilter)" />
                <path d="M60,450 C40,450 40,380 90,360 C80,340 120,320 150,330 C160,300 240,300 250,330 C280,320 320,340 310,360 C360,380 360,450 340,450 C340,480 60,480 60,450 Z" 
                      fill="#22c55e" filter="url(#displacementFilter)" />
                <path d="M90,340 C70,340 70,280 110,260 C100,240 140,220 160,230 C180,210 220,210 240,230 C260,220 300,240 290,260 C330,280 330,340 310,340 C310,360 90,360 90,340 Z" 
                      fill="#4ade80" filter="url(#displacementFilter)" />
                <path d="M120,230 C100,230 100,180 130,170 C120,150 150,130 170,140 C180,110 220,110 230,140 C250,130 280,150 270,170 C300,180 300,230 280,230 C280,250 120,250 120,230 Z" 
                      fill="#86efac" filter="url(#displacementFilter)" />
            </svg>

            <!-- ì‚¬ìš©ì ì»¤ìŠ¤í…€ íŠ¸ë¦¬ ì´ë¯¸ì§€ (game/tree.png) -->
            <img id="custom-tree-img" src="game/tree.png" class="absolute inset-0 w-full h-full object-contain pointer-events-none" alt="Custom Tree" onerror="this.style.display='none'; document.getElementById('default-tree-svg').classList.remove('hidden');" draggable="false">
            
            <div id="ornaments-layer" class="absolute inset-0 w-full h-full z-30"></div>
        </div>

        <div id="toast" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white/90 backdrop-blur text-slate-700 font-bold px-8 py-4 rounded-2xl shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 border-2 border-slate-200 text-center text-xl">
            ì™„ë£Œ!
        </div>

        <div id="preview-controls" class="absolute bottom-8 left-0 w-full px-6 flex justify-center gap-4 z-50 pointer-events-auto" data-html2canvas-ignore>
            <button onclick="togglePreviewMode(false)" class="bg-white/90 backdrop-blur text-slate-700 px-8 py-4 rounded-full font-bold shadow-lg border-2 border-slate-200 hover:bg-slate-50 transition-transform active:scale-95 text-xl">
                âœï¸ í¸ì§‘í•˜ê¸°
            </button>
            <button onclick="saveHighQualityImage()" class="bg-slate-800 text-white px-10 py-4 rounded-full font-bold shadow-lg border-2 border-slate-600 hover:bg-slate-900 transition-transform active:scale-95 flex items-center gap-2 text-xl">
                ğŸ“¸ ì €ì¥í•˜ê¸°
            </button>
        </div>

    </main>

    <!-- UI íŒ¨ë„ (í•˜ë‹¨ ê³ ì •: fixed bottom-0 left-0) -->
    <aside class="z-40 w-full h-[35vh] min-h-[250px] sketch-panel flex flex-col transition-transform duration-300 shadow-[0_-10px_40px_rgba(0,0,0,0.2)] fixed bottom-0 left-0" id="ui-panel">
        
        <div class="flex-1 overflow-hidden relative flex flex-col bg-slate-50/50 pt-4 rounded-t-3xl">
            <div id="palette" class="flex-1 p-4 grid grid-cols-4 gap-3 content-start justify-items-center overflow-y-auto"></div>
        </div>

        <div class="p-4 border-t border-slate-200 flex justify-between items-center bg-white shrink-0 pb-safe">
            <button onclick="changePage(-1)" id="btn-prev" class="page-btn">â—€</button>
            <span id="page-indicator" class="font-bold text-slate-500 text-2xl font-mono tracking-widest bg-slate-100 px-6 py-2 rounded-xl">1 / 1</span>
            <button onclick="changePage(1)" id="btn-next" class="page-btn">â–¶</button>
        </div>
    </aside>

    <input type="file" id="tree-upload" class="hidden-input" accept="image/*">
    <input type="file" id="bg-upload" class="hidden-input" accept="image/*">

    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        }, { passive: false });

        const safeAreaStyle = document.createElement('style');
        safeAreaStyle.innerHTML = `
            .pb-safe { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        `;
        document.head.appendChild(safeAreaStyle);

        // ì˜¤ë„ˆë¨¼íŠ¸ ë°ì´í„°
        const decorations = [
            // ë³„
            { id: 'star', name: 'ë³„', html: '<svg viewBox="0 0 24 24" style="color: #fcd34d;"><path fill="currentColor" stroke="#fbbf24" stroke-width="1.5" stroke-linejoin="round" d="M12 2l2.5 7h7.5l-6 4.5 2.5 7-6.5-4.5-6.5 4.5 2.5-7-6-4.5h7.5z"/></svg>', size: 70 },
            
            // LED ì „êµ¬
            { id: 'ball-red', name: 'ë¹›ë‚˜ëŠ” ë¹¨ê°• ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #f87171;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#ef4444" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#b91c1c" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },
            { id: 'ball-yellow', name: 'ë¹›ë‚˜ëŠ” ë…¸ë‘ ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #fde047;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#eab308" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#854d0e" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },
            { id: 'ball-teal', name: 'ë¹›ë‚˜ëŠ” ì²­ë¡ ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #5eead4;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#14b8a6" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#0f766e" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },
            { id: 'ball-blue', name: 'ë¹›ë‚˜ëŠ” íŒŒë‘ ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #3b82f6;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#1d4ed8" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#1e3a8a" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },
            { id: 'ball-green', name: 'ë¹›ë‚˜ëŠ” ì´ˆë¡ ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #22c55e;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#15803d" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#14532d" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },
            { id: 'ball-purple', name: 'ë¹›ë‚˜ëŠ” ë³´ë¼ ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #a855f7;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#7e22ce" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#581c87" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },
            { id: 'ball-pink', name: 'ë¹›ë‚˜ëŠ” í•‘í¬ ë³¼', type: 'light', html: '<svg viewBox="0 0 24 24" style="color: #ec4899;"><circle cx="12" cy="13" r="9" fill="currentColor" stroke="#be185d" stroke-width="1.5"/><rect x="10" y="2" width="4" height="4" fill="#831843" rx="1"/><path d="M15 10q2 2 0 4" stroke="white" stroke-width="2" fill="none" opacity="0.5"/></svg>', size: 50 },

            { id: 'candy', name: 'ì§€íŒ¡ì´', html: '<svg viewBox="0 0 24 24"><path d="M7 19v-6a5 5 0 0 1 10 0" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round"/><path d="M7 19v-6a5 5 0 0 1 10 0" fill="none" stroke="#f43f5e" stroke-width="6" stroke-linecap="round" stroke-dasharray="3 4"/></svg>', size: 55 },
            { id: 'gift', name: 'ì„ ë¬¼ ìƒì', html: '<svg viewBox="0 0 24 24"><rect x="4" y="9" width="16" height="13" rx="2" fill="#86efac" stroke="#22c55e" stroke-width="1.5"/><rect x="10" y="9" width="4" height="13" fill="#ef4444"/><rect x="2" y="6" width="20" height="4" rx="1" fill="#ef4444"/><path d="M12 6L8 2M12 6L16 2" stroke="#ef4444" stroke-width="3" stroke-linecap="round"/></svg>', size: 60 },
            { id: 'gingerbread', name: 'ì§„ì €ë¸Œë ˆë“œë§¨', html: '<svg viewBox="0 0 24 24"><path d="M12 2c-1.7 0-3 1.3-3 3c0 .6.2 1.2.5 1.7L6 9c-.6.2-1 .8-1 1.5v1c0 .8.7 1.5 1.5 1.5h.5l1 4l-1 2c-.3.6 0 1.4.6 1.8l.9.4c.6.3 1.4 0 1.8-.6l1.7-3.4h2l1.7 3.4c.3.6 1.1.9 1.8.6l.9-.4c.6-.3.9-1.1.6-1.8l-1-2l1-4h.5c.8 0 1.5-.7 1.5-1.5v-1c0-.7-.4-1.3-1-1.5l-3.5-2.3c.3-.5.5-1.1.5-1.7c0-1.7-1.3-3-3-3z" fill="#cd853f" stroke="#8b4513" stroke-width="1"/><circle cx="11" cy="4" r="0.8" fill="white"/><circle cx="13" cy="4" r="0.8" fill="white"/><circle cx="12" cy="9" r="0.8" fill="#ef4444"/><circle cx="12" cy="12" r="0.8" fill="#ef4444"/><path d="M11 6q1 1 2 0" stroke="white" stroke-width="0.8" fill="none"/></svg>', size: 60 },
            { id: 'ribbon', name: 'ë¦¬ë³¸', html: '<svg viewBox="0 0 50 50"><path d="M25 25 C 15 15 5 15 5 25 C 5 35 15 35 25 25 Z" fill="#ef4444" stroke="#991b1b" stroke-width="1.5"/><path d="M25 25 C 35 15 45 15 45 25 C 45 35 35 35 25 25 Z" fill="#ef4444" stroke="#991b1b" stroke-width="1.5"/><path d="M25 25 L 18 45 L 25 40 L 32 45 L 25 25" fill="#ef4444" stroke="#991b1b" stroke-width="1.5"/><circle cx="25" cy="25" r="4" fill="#b91c1c"/></svg>', size: 60 },

            // DVL-10 (ëŒ€ë‚˜ë¬´ì´): ì´ì „ì— ì¢‹ì•˜ë˜ ë²„ì „ (ì„ ëª…í•œ SVG)
            { 
                id: 'dvl10', 
                name: 'DVL-10(ëŒ€ë‚˜ë¬´ì´)', 
                html: '<svg viewBox="0 0 140 50"><rect x="20" y="20" width="80" height="12" fill="#4ade80" /><path d="M20 20 L100 20 L100 32 L20 32 Z" fill="none" stroke="#166534" stroke-width="2" /><rect x="100" y="18" width="10" height="16" rx="2" fill="#1f2937"/><rect x="110" y="22" width="25" height="8" rx="1" fill="#1f2937"/><rect x="60" y="14" width="40" height="6" rx="2" fill="#1f2937"/><rect x="50" y="32" width="15" height="12" rx="2" fill="#1f2937"/><path d="M25 32 L20 45 L35 45 L40 32" fill="#166534"/></svg>', 
                width: 140, 
                height: 50 
            },

            // ê·¸ë˜í”½ì¹´ë“œ (SVG)
            { id: 'gpu', name: 'ê·¸ë˜í”½ì¹´ë“œ', html: '<svg viewBox="0 0 100 60"><rect x="5" y="10" width="90" height="40" rx="4" fill="#374151" stroke="#1f2937" stroke-width="2"/><circle cx="30" cy="30" r="15" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/><circle cx="70" cy="30" r="15" fill="#1f2937" stroke="#9ca3af" stroke-width="2"/><rect x="5" y="50" width="90" height="5" fill="#fbbf24"/><path d="M25 30 L35 30 M30 25 L30 35" stroke="#4b5563" stroke-width="2"/><path d="M65 30 L75 30 M70 25 L70 35" stroke="#4b5563" stroke-width="2"/></svg>', width: 100, height: 60 },

            // COFDM(ë¼ë””ì˜¤): #3f3f3f (ì§™ì€ íšŒìƒ‰) ë²„ì „
            { 
                id: 'cofdm', 
                name: 'COFDM(ë¼ë””ì˜¤)', 
                html: '<svg viewBox="0 0 64 85"><line x1="22" y1="25" x2="22" y2="5" stroke="#1f2937" stroke-width="4" stroke-linecap="round" /><line x1="42" y1="25" x2="42" y2="5" stroke="#1f2937" stroke-width="4" stroke-linecap="round" /><rect x="12" y="25" width="40" height="55" rx="3" fill="#3f3f3f" stroke="#1f2937" stroke-width="2"/><rect x="16" y="32" width="32" height="20" fill="#111827" rx="1" /><rect x="18" y="34" width="28" height="16" fill="#84cc16" opacity="0.7" /><circle cx="20" cy="62" r="2.5" fill="#1f2937" /><circle cx="32" cy="62" r="2.5" fill="#1f2937" /><circle cx="44" cy="62" r="2.5" fill="#1f2937" /><circle cx="20" cy="70" r="2.5" fill="#1f2937" /><circle cx="32" cy="70" r="2.5" fill="#1f2937" /><circle cx="44" cy="70" r="2.5" fill="#b91c1c" /></svg>', 
                width: 64, 
                height: 85 
            },

            // PlayStation 5
            { 
                id: 'ps5', 
                name: 'í”Œë ˆì´ìŠ¤í…Œì´ì…˜5', 
                html: '<svg viewBox="0 0 60 80"><path d="M12 75 C 8 50 8 20 12 5 L 48 5 C 52 20 52 50 48 75 Z" fill="#111827" /><path d="M12 75 C 2 75 2 5 12 5 C 15 5 15 75 12 75 Z" fill="#f3f4f6" stroke="#e5e7eb" /><path d="M48 75 C 58 75 58 5 48 5 C 45 5 45 75 48 75 Z" fill="#f3f4f6" stroke="#e5e7eb" /><circle cx="20" cy="15" r="1" fill="#3b82f6" opacity="0.8"/></svg>', 
                width: 60, 
                height: 80 
            },
            
            // Switch 2
            { 
                id: 'switch2', 
                name: 'ìŠ¤ìœ„ì¹˜2', 
                html: '<svg viewBox="0 0 80 40"><rect x="10" y="5" width="60" height="30" rx="2" fill="#1f2937" stroke="#374151" stroke-width="2"/><rect x="15" y="8" width="50" height="24" fill="#000" /><path d="M10 5 Q 0 5 0 20 Q 0 35 10 35 Z" fill="#0ea5e9" /><path d="M70 5 Q 80 5 80 20 Q 80 35 70 35 Z" fill="#ef4444" /><circle cx="5" cy="12" r="2" fill="#1f2937" opacity="0.5"/><circle cx="5" cy="18" r="2" fill="#1f2937" opacity="0.5"/><circle cx="5" cy="24" r="2" fill="#1f2937" opacity="0.5"/><circle cx="5" cy="30" r="2" fill="#1f2937" opacity="0.5"/><circle cx="75" cy="15" r="3" fill="#1f2937" opacity="0.5"/><circle cx="75" cy="25" r="1.5" fill="#1f2937" opacity="0.5"/></svg>', 
                width: 80, 
                height: 40 
            },

            // ì¶”ê°€ëœ ì´ë¯¸ì§€ ì˜¤ë„ˆë¨¼íŠ¸ 28ì¢…
            { id: 'orn1', name: 'êµ¿ì¦ˆ - ë‹¬ê³ ë‚˜', html: '<img src="game/orn (1).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="êµ¿ì¦ˆ - ë‹¬ê³ ë‚˜" draggable="false">', size: 60 },
            { id: 'orn2', name: 'ì¹˜ì§€ì§', html: '<img src="game/orn (2).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì¹˜ì§€ì§" draggable="false">', size: 60 },
            { id: 'orn3', name: 'ì¹˜ì¦ˆ', html: '<img src="game/orn (3).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì¹˜ì¦ˆ" draggable="false">', size: 60 },
            { id: 'orn4', name: 'í†µë‚˜ë¬´ íŒŒì›Œ', html: '<img src="game/orn (4).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="í†µë‚˜ë¬´ íŒŒì›Œ" draggable="false">', size: 60 },
            { id: 'orn5', name: 'ì‹¤í¬ì†¡', html: '<img src="game/orn (5).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì‹¤í¬ì†¡" draggable="false">', size: 60 },
            { id: 'orn6', name: 'ê²Ÿ íˆ¬ ì›Œí¬', html: '<img src="game/orn (6).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ê²Ÿ íˆ¬ ì›Œí¬" draggable="false">', size: 60 },
            { id: 'orn7', name: 'í™œí˜‘ì „', html: '<img src="game/orn (7).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="í™œí˜‘ì „" draggable="false">', size: 60 },
            { id: 'orn8', name: 'ë² ì´ë¹„ ìŠ¤í…', html: '<img src="game/orn (8).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë² ì´ë¹„ ìŠ¤í…" draggable="false">', size: 60 },
            { id: 'orn9', name: '13ì›”ì˜ ê·¸ë¦¬ìš´ ë³µìˆ˜ - ì•¡ì', html: '<img src="game/orn (9).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="13ì›”ì˜ ê·¸ë¦¬ìš´ ë³µìˆ˜ - ì•¡ì" draggable="false">', size: 60 },
            { id: 'orn10', name: 'ê·¸ë¦¼ìë³µë„2 - ê³¡ì˜¥', html: '<img src="game/orn (10).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ê·¸ë¦¼ìë³µë„2 - ê³¡ì˜¥" draggable="false">', size: 60 },
            { id: 'orn11', name: 'íŒŒí”¼ í”Œë ˆì´íƒ€ì„ ì±•í„°4', html: '<img src="game/orn (11).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="íŒŒí”¼ í”Œë ˆì´íƒ€ì„ ì±•í„°4" draggable="false">', size: 60 },
            { id: 'orn12', name: 'ì•„ë§Œë‹¤3', html: '<img src="game/orn (12).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì•„ë§Œë‹¤3" draggable="false">', size: 60 },
            { id: 'orn13', name: 'ë¼íƒ€íƒ„', html: '<img src="game/orn (13).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë¼íƒ€íƒ„" draggable="false">', size: 60 },
            { id: 'orn14', name: 'ë¹„ì¸  ì•¤ ë°¥ìŠ¤', html: '<img src="game/orn (14).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë¹„ì¸  ì•¤ ë°¥ìŠ¤" draggable="false">', size: 60 },
            { id: 'orn15', name: 'ì–¸ëª¬ë“œ - ë¹„ë°€ë²ˆí˜¸', html: '<img src="game/orn (15).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì–¸ëª¬ë“œ - ë¹„ë°€ë²ˆí˜¸" draggable="false">', size: 60 },
            { id: 'orn16', name: 'ì‚¬ê³¼ê²Œì„', html: '<img src="game/orn (16).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì‚¬ê³¼ê²Œì„" draggable="false">', size: 60 },
            { id: 'orn17', name: 'ë§ˆì´ ë¦¬í‹€ í¼í”¼', html: '<img src="game/orn (17).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë§ˆì´ ë¦¬í‹€ í¼í”¼" draggable="false">', size: 60 },
            { id: 'orn18', name: 'ì‚°íƒ€', html: '<img src="game/orn (18).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì‚°íƒ€" draggable="false">', size: 60 },
            { id: 'orn19', name: 'ë”¸ê¸°', html: '<img src="game/orn (19).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë”¸ê¸°" draggable="false">', size: 60 },
            { id: 'orn20', name: 'ì œìœ¡ë³µ', html: '<img src="game/orn (20).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì œìœ¡ë³µ" draggable="false">', size: 60 },
            { id: 'orn21', name: 'í’ë…ì´', html: '<img src="game/orn (21).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="í’ë…ì´" draggable="false">', size: 60 },
            { id: 'orn22', name: 'ë¬¼ê°œ', html: '<img src="game/orn (22).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë¬¼ê°œ" draggable="false">', size: 60 },
            { id: 'orn23', name: 'ì í¬ë¦¬íŠ¸', html: '<img src="game/orn (23).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì í¬ë¦¬íŠ¸" draggable="false">', size: 60 },
            { id: 'orn24', name: 'íŠ¸ë¦¬', html: '<img src="game/orn (24).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="íŠ¸ë¦¬" draggable="false">', size: 60 },
            { id: 'orn25', name: 'ë£¨ëŒí”„', html: '<img src="game/orn (25).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ë£¨ëŒí”„" draggable="false">', size: 60 },
            { id: 'orn26', name: 'ì„ ë¬¼ í’ë…ì´', html: '<img src="game/orn (26).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì„ ë¬¼ í’ë…ì´" draggable="false">', size: 60 },
            { id: 'orn27', name: 'ëˆˆì‚¬ëŒ', html: '<img src="game/orn (27).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ëˆˆì‚¬ëŒ" draggable="false">', size: 60 },
            { id: 'orn28', name: 'ì–‘ë§', html: '<img src="game/orn (28).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="ì–‘ë§" draggable="false">', size: 60 },
            { 
                id: 'poong', 
                name: 'í’í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 
                html: '<img src="game/poong.png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="í’í¬ë¦¬ìŠ¤ë§ˆìŠ¤" draggable="false">', 
                customPreview: '<img src="game/poong (1).png" class="w-full h-full object-contain pointer-events-none drop-shadow-sm" alt="í’í¬ë¦¬ìŠ¤ë§ˆìŠ¤" draggable="false">',
                size: 60 
            },
        ];
        
        const paletteEl = document.getElementById('palette');
        const ornamentLayer = document.getElementById('ornaments-layer');
        const dropZone = document.getElementById('drop-zone');
        
        // ë°˜ì‘í˜• ì•„ì´í…œ ê°œìˆ˜ ì„¤ì •
        let itemsPerPage = window.innerWidth >= 1024 ? 20 : 8; // PC: 20ê°œ, ëª¨ë°”ì¼: 8ê°œ
        let currentPage = 1;
        
        let draggedItem = null;
        let activeClone = null;
        let selectedItem = null;

        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ì•„ì´í…œ ê°œìˆ˜ ìë™ ì¡°ì ˆ
        window.addEventListener('resize', () => {
            const newItemsPerPage = window.innerWidth >= 1024 ? 20 : 8;
            if (newItemsPerPage !== itemsPerPage) {
                itemsPerPage = newItemsPerPage;
                currentPage = 1; // í˜ì´ì§€ ì´ˆê¸°í™”
                renderPalette();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (selectedItem && (e.key === 'Delete' || e.key === 'Backspace')) {
                const rect = selectedItem.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                createPoofEffect(centerX, centerY);
                selectedItem.remove();
                selectedItem = null; 
            }
        });

        document.getElementById('capture-area').addEventListener('click', function(e) {
            if (e.target.id === 'capture-area' || e.target.classList.contains('tree-container')) {
                deselectAll();
            }
        });

        function openResetModal() {
            document.getElementById('reset-modal').classList.remove('hidden');
        }

        function closeResetModal() {
            document.getElementById('reset-modal').classList.add('hidden');
        }

        function performReset() {
            ornamentLayer.innerHTML = '';
            
            const treeImg = document.getElementById('custom-tree-img');
            const defaultSvg = document.getElementById('default-tree-svg');
            
            treeImg.src = 'game/tree.png';
            treeImg.classList.remove('hidden');
            if(defaultSvg) defaultSvg.classList.add('hidden');

            const bgLayer = document.getElementById('custom-bg-layer');
            if(bgLayer) {
                bgLayer.style.backgroundImage = '';
                bgLayer.classList.add('hidden');
            }

            deselectAll();
            closeResetModal();
            showToast('ê¹¨ë—í•˜ê²Œ ì§€ì›Œì¡Œì–´ìš”!');
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function togglePreviewMode(showPreview) {
            const body = document.body;
            if (showPreview) deselectAll();
            
            if (showPreview) {
                body.classList.add('preview-mode');
            } else {
                body.classList.remove('preview-mode');
            }
        }

        async function saveHighQualityImage() {
            deselectAll();
            const loading = document.getElementById('loading-overlay');
            // loading.classList.remove('hidden'); // ë¡œë”© í™”ë©´ ì‚­ì œ
            
            const snowflakes = document.querySelectorAll('.snowflake');
            const frozenStates = [];
            
            snowflakes.forEach(flake => {
                const computed = window.getComputedStyle(flake);
                const transform = computed.transform;
                
                frozenStates.push({
                    element: flake,
                    animation: flake.style.animation,
                    transform: flake.style.transform
                });

                flake.style.animation = 'none';
                flake.style.transform = transform; 
            });

            await new Promise(resolve => setTimeout(resolve, 350));

            const mainElement = document.getElementById('capture-area');
            const isPc = window.innerWidth >= 1024;
            
            if (isPc) {
                mainElement.style.setProperty('width', '100vw', 'important');
                mainElement.style.setProperty('margin-right', '0', 'important');
            }

            try {
                const body = document.body;
                const wasInPreview = body.classList.contains('preview-mode');
                if (!wasInPreview) body.classList.add('preview-mode');

                await new Promise(resolve => setTimeout(resolve, 100));

                const captureElement = document.body; 

                const canvas = await html2canvas(captureElement, {
                    scale: 3, 
                    backgroundColor: null,
                    useCORS: true,
                    ignoreElements: (element) => {
                        if (element.id === 'ui-panel') return true;
                        if (element.id === 'top-toolbar') return true;
                        if (element.id === 'preview-controls') return true;
                        if (element.id === 'loading-overlay') return true;
                        if (element.id === 'reset-modal') return true;
                        if (element.hasAttribute('data-html2canvas-ignore')) return true;
                        return false;
                    }
                });

                const link = document.createElement('a');
                link.download = 'my-christmas-tree.png';
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
                
                showToast('ì €ì¥ ì™„ë£Œ!');
                
                if (!wasInPreview) body.classList.remove('preview-mode');

            } catch (err) {
                console.error(err);
                showToast('ì €ì¥ ì‹¤íŒ¨ ã… ã… ');
            } finally {
                if (isPc) {
                    mainElement.style.removeProperty('width');
                    mainElement.style.removeProperty('margin-right');
                }

                frozenStates.forEach(state => {
                    state.element.style.animation = state.animation;
                    state.element.style.transform = state.transform;
                });
                
                // loading.classList.add('hidden'); // ë¡œë”© í™”ë©´ ì‚­ì œ
            }
        }

        function renderPalette() {
            paletteEl.innerHTML = '';
            const totalPages = Math.ceil(decorations.length / itemsPerPage);
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const currentItems = decorations.slice(start, end);

            document.getElementById('page-indicator').innerText = `${currentPage} / ${totalPages > 0 ? totalPages : 1}`;
            document.getElementById('btn-prev').disabled = currentPage === 1;
            document.getElementById('btn-next').disabled = currentPage === totalPages || totalPages === 0;

            currentItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shelf-slot cursor-pointer';
                
                const previewHtml = item.customPreview || item.html;

                div.innerHTML = `
                    ${previewHtml}
                    <div class="item-name">${item.name}</div>
                `;
                
                div.addEventListener('touchstart', (e) => startDrag(e, item), {passive: false});
                div.addEventListener('mousedown', (e) => startDrag(e, item));
                paletteEl.appendChild(div);
            });
        }

        function changePage(delta) {
            currentPage += delta;
            renderPalette();
        }

        function startDrag(e, itemData) {
            e.preventDefault();
            deselectAll();

            let clientX, clientY;
            if(e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            draggedItem = itemData;

            activeClone = document.createElement('div');
            activeClone.className = 'drag-clone';
            activeClone.innerHTML = itemData.html;
            
            const w = itemData.width || itemData.size;
            const h = itemData.height || itemData.size;
            
            activeClone.style.width = `${w}px`;
            activeClone.style.height = `${h}px`;
            activeClone.style.left = `${clientX}px`;
            activeClone.style.top = `${clientY}px`;
            
            document.body.appendChild(activeClone);

            document.addEventListener('touchmove', onDragMove, {passive: false});
            document.addEventListener('touchend', onDragEnd);
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragEnd);
        }

        function onDragMove(e) {
            e.preventDefault();
            let clientX, clientY;
            if(e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            if(activeClone) {
                activeClone.style.left = `${clientX}px`;
                activeClone.style.top = `${clientY}px`;
            }
        }

        function onDragEnd(e) {
            let clientX, clientY;
            if(e.changedTouches) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            if (!draggedItem || !activeClone) return;

            const dropRect = dropZone.getBoundingClientRect();
            
            placeItem(clientX, clientY);

            activeClone.remove();
            activeClone = null;
            draggedItem = null;
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('touchend', onDragEnd);
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
        }

        function placeItem(clientX, clientY) {
            const rect = ornamentLayer.getBoundingClientRect();
            const relativeX = clientX - rect.left;
            const relativeY = clientY - rect.top;

            const el = document.createElement('div');
            el.className = 'placed-item';
            
            if (draggedItem.type === 'light' || draggedItem.id === 'star') {
                el.classList.add('led-anim');
            }

            el.innerHTML = draggedItem.html + '<div class="resizer"></div><div class="rotator"></div>';
            
            const w = draggedItem.width || draggedItem.size;
            const h = draggedItem.height || draggedItem.size;
            
            el.style.width = `${w}px`;
            el.style.height = `${h}px`;
            el.style.left = `${relativeX - (w / 2)}px`;
            el.style.top = `${relativeY - (h / 2)}px`;
            
            el.style.transform = 'none';

            makeDraggable(el);
            initResizer(el);
            initRotator(el);

            ornamentLayer.appendChild(el);
            
            selectItem(el);
            
            createPoofEffect(clientX, clientY);
        }

        function selectItem(el) {
            deselectAll();
            el.classList.add('selected');
            selectedItem = el;
        }

        function deselectAll() {
            const selected = document.querySelectorAll('.placed-item.selected');
            selected.forEach(el => el.classList.remove('selected'));
            selectedItem = null;
        }

        function initResizer(el) {
            const resizer = el.querySelector('.resizer');
            
            const startResize = function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                let startX, startY, startWidth, startHeight;
                
                if (e.touches) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    startX = e.clientX;
                    startY = e.clientY;
                }
                
                startWidth = parseFloat(getComputedStyle(el).width);
                startHeight = parseFloat(getComputedStyle(el).height);
                
                const aspectRatio = startWidth / startHeight;

                const doResize = function(e) {
                    let clientX, clientY;
                    if (e.touches) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
                    
                    const widthChange = clientX - startX;
                    let newWidth = startWidth + widthChange;
                    
                    if (newWidth < 20) newWidth = 20;
                    
                    el.style.width = `${newWidth}px`;
                    el.style.height = `${newWidth / aspectRatio}px`;
                };

                const stopResize = function() {
                    document.removeEventListener('touchmove', doResize);
                    document.removeEventListener('touchend', stopResize);
                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', stopResize);
                };

                document.addEventListener('touchmove', doResize, {passive: false});
                document.addEventListener('touchend', stopResize);
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
            };

            resizer.addEventListener('mousedown', startResize);
            resizer.addEventListener('touchstart', startResize, {passive: false});
        }

        function initRotator(el) {
            const rotator = el.querySelector('.rotator');
            
            const startRotate = function(e) {
                e.stopPropagation();
                e.preventDefault();
                
                const rect = el.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const doRotate = function(e) {
                    let clientX, clientY;
                    if (e.touches) {
                        clientX = e.touches[0].clientX;
                        clientY = e.touches[0].clientY;
                    } else {
                        clientX = e.clientX;
                        clientY = e.clientY;
                    }
                    
                    const angle = Math.atan2(clientY - centerY, clientX - centerX);
                    const degree = angle * (180 / Math.PI) + 90; // +90 for top handle adjustment
                    
                    el.style.transform = `rotate(${degree}deg)`;
                };

                const stopRotate = function() {
                    document.removeEventListener('touchmove', doRotate);
                    document.removeEventListener('touchend', stopRotate);
                    document.removeEventListener('mousemove', doRotate);
                    document.removeEventListener('mouseup', stopRotate);
                };

                document.addEventListener('touchmove', doRotate, {passive: false});
                document.addEventListener('touchend', stopRotate);
                document.addEventListener('mousemove', doRotate);
                document.addEventListener('mouseup', stopRotate);
            };

            rotator.addEventListener('mousedown', startRotate);
            rotator.addEventListener('touchstart', startRotate, {passive: false});
        }

        function makeDraggable(el) {
            let isDragging = false;
            let startX, startY;
            let initialLeft, initialTop;
            let hasMoved = false;
            let lastClickTime = 0; 

            const startHandler = function(e) {
                if (e.target.classList.contains('resizer') || e.target.classList.contains('rotator')) return;

                e.stopPropagation();
                e.preventDefault();
                
                selectItem(el);

                isDragging = true;
                hasMoved = false;

                ornamentLayer.appendChild(el);
                el.classList.add('is-dragging');

                if(e.touches) {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    startX = e.clientX;
                    startY = e.clientY;
                }
                
                initialLeft = parseFloat(el.style.left);
                initialTop = parseFloat(el.style.top);

                document.addEventListener('touchmove', moveHandler, {passive: false});
                document.addEventListener('touchend', endHandler);
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', endHandler);
            };

            const moveHandler = function(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                let clientX, clientY;
                if(e.touches) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const dx = clientX - startX;
                const dy = clientY - startY;

                if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;

                el.style.left = `${initialLeft + dx}px`;
                el.style.top = `${initialTop + dy}px`;
            };

            const endHandler = function(e) {
                isDragging = false;
                el.classList.remove('is-dragging');
                
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('touchend', endHandler);
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', endHandler);

                const rect = dropZone.getBoundingClientRect();
                const elRect = el.getBoundingClientRect();
                
                if (
                    elRect.right < 0 || 
                    elRect.left > window.innerWidth || 
                    elRect.bottom < 0 || 
                    elRect.top > window.innerHeight
                ) {
                    createPoofEffect(elRect.left + elRect.width/2, elRect.top + elRect.height/2);
                    el.remove();
                    return;
                }

                if (!hasMoved) {
                    const currentTime = new Date().getTime();
                    const timeDiff = currentTime - lastClickTime;
                    
                    if (timeDiff < 300 && timeDiff > 0) {
                        const center = { x: elRect.left + elRect.width/2, y: elRect.top + elRect.height/2 };
                        createPoofEffect(center.x, center.y);
                        el.remove();
                        lastClickTime = 0;
                        selectedItem = null;
                    } else {
                        lastClickTime = currentTime;
                    }
                }
            };

            el.addEventListener('touchstart', startHandler, {passive: false});
            el.addEventListener('mousedown', startHandler);
        }

        function createPoofEffect(x, y) {
            const poof = document.createElement('div');
            poof.style.position = 'fixed';
            poof.style.left = x + 'px';
            poof.style.top = y + 'px';
            poof.style.transform = 'translate(-50%, -50%)';
            poof.style.pointerEvents = 'none';
            poof.style.zIndex = '9999';
            poof.innerHTML = `
                <svg width="60" height="60" viewBox="0 0 24 24" fill="#cbd5e1">
                    <circle cx="12" cy="12" r="10" opacity="0.8">
                        <animate attributeName="r" from="0" to="18" dur="0.4s" fill="freeze"/>
                        <animate attributeName="opacity" from="0.8" to="0" dur="0.4s" fill="freeze"/>
                    </circle>
                </svg>
            `;
            document.body.appendChild(poof);
            setTimeout(() => poof.remove(), 400);
        }

        function createSnow() {
            const container = document.getElementById('snow-container');
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.innerText = ['â„', 'â…', 'â†', 'â€¢'][Math.floor(Math.random() * 4)];
            const left = Math.random() * 100;
            const size = Math.random() * 10 + 10;
            const duration = Math.random() * 5 + 5;
            const delay = Math.random() * 5;
            flake.style.left = `${left}vw`;
            flake.style.fontSize = `${size}px`;
            flake.style.animationDuration = `${duration}s`;
            flake.style.animationDelay = `${delay}s`;
            container.appendChild(flake);
            setTimeout(() => { flake.remove(); }, (duration + delay) * 1000);
        }
        setInterval(createSnow, 300);

        renderPalette();
    </script>
</body>
</html>
